<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson — LinguaLab</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root { 
            --primary: #22d3ee; 
            --primary-dark: #0ea5e9;
            --navy: #1f4e79; 
            --bg: #f8fafc; 
            --white: #ffffff; 
            --orange: #f97316; 
            --radius: 20px;
            --shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #334155; padding-top: 80px; }
        
        /* --- ICONS (SVG) --- */
        .icon { width: 24px; height: 24px; fill: currentColor; }
        .icon-lg { width: 48px; height: 48px; fill: currentColor; }

        /* --- NAVBAR --- */
        .navbar {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px 40px; background: #fff; box-shadow: 0 4px 20px rgba(0,0,0,.05);
            height: 80px;
        }
        .navbar-left { display: flex; align-items: center; gap: 12px; }
        .nav-logo { height: 40px; width: auto; display: block; }
        .nav-title { font-size: 22px; font-weight: 800; color: var(--navy); }
        .navbar-right { display: flex; align-items: center; gap: 20px; }
        .navbar-right a { 
            color: var(--navy); font-weight: 600; text-decoration: none; 
            font-size: 14px; transition: 0.3s;
        }
        .navbar-right a:hover { color: var(--primary); }

        /* --- PROGRESS BAR --- */
        .progress-container {
            position: fixed; top: 80px; left: 0; width: 100%; height: 6px; background: #e2e8f0; z-index: 999;
        }
        .progress-fill {
            height: 100%; background: var(--orange); width: 0%; transition: width 0.5s ease;
        }

        /* --- HERO --- */
        .hero-compact {
            width: 100%;
            padding: 60px 20px 140px;
            text-align: center;
            background: linear-gradient(135deg, #22d3ee, #a78bfa);
            color: #fff;
            position: relative;
        }
        .hero-compact h1 { font-size: 38px; font-weight: 800; margin-bottom: 5px; }
        .hero-date { opacity: 0.9; font-size: 16px; font-weight: 500; }

        /* --- CONTAINER --- */
        .container { 
            max-width: 800px; margin: -100px auto 40px; 
            padding: 0 20px; position: relative; z-index: 10;
        }

        /* --- BACK BUTTON --- */
        .back-btn-wrapper { text-align: center; margin-bottom: 30px; }
        .back-btn { 
            display: inline-flex; align-items: center; text-decoration: none; 
            color: var(--navy); font-weight: 700; gap: 8px;
            background: white; padding: 12px 30px; border-radius: 99px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); transition: 0.3s;
        }
        .back-btn:hover { transform: translateY(-2px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }

        /* --- LESSON HEADER --- */
        .lesson-header-card { 
            background: white; border-radius: var(--radius); padding: 40px 30px; 
            margin-bottom: 30px; text-align: center;
            box-shadow: var(--shadow); border-top: 6px solid var(--primary);
        }
        .lesson-tag { 
            background: #e0f2fe; color: var(--navy); padding: 6px 14px; 
            border-radius: 20px; font-size: 12px; text-transform: uppercase; 
            letter-spacing: 1px; font-weight: 700;
        }
        .lesson-title { font-size: 28px; font-weight: 800; color: var(--navy); margin: 15px 0 10px; }
        .lesson-goal { 
            background: #fff7ed; color: #9a3412; padding: 15px; border-radius: 12px;
            font-size: 15px; line-height: 1.5; text-align: left; margin-top: 20px;
            border-left: 4px solid var(--orange);
        }

        /* --- STEP CARDS --- */
        .step-card { 
            background: white; border-radius: 20px; padding: 30px; margin-bottom: 25px; 
            border: 1px solid #e2e8f0; position: relative; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.02); transition: 0.3s;
        }
        .step-card:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }

        .step-badge {
            display: inline-block; font-size: 11px; font-weight: 800; text-transform: uppercase; 
            color: #fff; background: var(--navy); padding: 4px 10px; border-radius: 6px;
            margin-bottom: 15px; letter-spacing: 0.5px;
        }
        .badge-vocab { background: #3b82f6; }
        .badge-phonics { background: #8b5cf6; }
        .badge-tpr { background: #f59e0b; }
        .badge-speak { background: #ef4444; }

        .step-title { font-weight: 800; color: var(--navy); font-size: 20px; margin-bottom: 10px; }
        .step-desc-en { font-size: 18px; color: #0f172a; font-weight: 600; margin-bottom: 5px; }
        .step-desc-zh { font-size: 15px; color: #64748b; line-height: 1.6; }

        /* --- FLASHCARDS GRID --- */
        .flashcards-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px; margin-top: 20px;
        }
        .flashcard {
            background: #f0f9ff; border: 2px solid #bae6fd; border-radius: 16px;
            padding: 20px; text-align: center; cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 120px;
        }
        .flashcard:hover { background: #e0f2fe; transform: scale(1.03); border-color: var(--primary); }
        .flashcard-word { font-weight: 800; color: var(--navy); font-size: 18px; margin-bottom: 5px; }
        .flashcard-zh { font-size: 13px; color: #64748b; }
        .play-icon { width: 20px; height: 20px; fill: var(--primary); margin-top: 8px; opacity: 0.7; }

        /* --- AUDIO BOX --- */
        .audio-box { 
            background: #fff7ed; padding: 25px; border-radius: 20px; 
            display: flex; align-items: center; gap: 20px; border: 1px solid #fed7aa; margin-top: 20px;
        }
        .rec-btn { 
            width: 64px; height: 64px; border-radius: 50%; border: none; 
            background: #ef4444; color: white; cursor: pointer; 
            display: flex; justify-content: center; align-items: center; 
            transition: 0.2s; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }
        .rec-btn:hover { transform: scale(1.05); }
        .rec-btn.recording { animation: pulse 1.5s infinite; background: #991b1b; }
        
        .listen-btn {
            background: white; border: 2px solid var(--primary); color: var(--navy);
            padding: 10px 20px; border-radius: 99px; font-weight: 700; cursor: pointer;
            margin-top: 10px; font-size: 14px; display: inline-flex; align-items: center; gap: 8px;
            transition: 0.2s;
        }
        .listen-btn:hover { background: var(--primary-light); }

        /* --- FOOTER BUTTON --- */
        .complete-btn { 
            background: var(--navy); color: white; border: none; padding: 22px; 
            border-radius: 16px; font-size: 18px; font-weight: 800; cursor: pointer; 
            transition: 0.3s; width: 100%; margin-top: 30px; display: flex; 
            justify-content: center; align-items: center; gap: 10px;
            box-shadow: 0 10px 20px rgba(31, 78, 121, 0.15);
        }
        .complete-btn:hover { background: #334155; transform: translateY(-3px); }

        /* --- MODAL --- */
        .sticker-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); 
            display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(8px);
        }
        .sticker-content { 
            background: white; padding: 50px; border-radius: 30px; text-align: center; 
            box-shadow: 0 25px 60px rgba(0,0,0,0.3); max-width: 400px; width: 90%;
            animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .sticker-icon { color: #eab308; width: 80px; height: 80px; margin-bottom: 20px; }

        @keyframes pop { 0% { transform: scale(0); } 100% { transform: scale(1); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.6); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } }

        /* MOBILE */
        @media (max-width: 600px) {
            .navbar { padding: 10px 20px; flex-direction: column; gap: 10px; height: auto; }
            .navbar-right { width: 100%; justify-content: center; flex-wrap: wrap; border-top: 1px solid #f1f5f9; padding-top: 10px; }
            .hero-compact h1 { font-size: 32px; }
            .content-wrapper { margin-top: -80px; }
            .progress-container { top: 110px; }
            .flashcards-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="progress-container"><div class="progress-fill" id="progress-bar"></div></div>

<nav class="navbar">
    <div class="navbar-left">
        <img src="assets/img/logo.png" alt="LL" class="nav-logo" onerror="this.style.display='none'">
        <span class="nav-title">LinguaLab</span>
    </div>
    <nav class="navbar-right">
        <a href="grammar.html">Grammar Magic</a>
        <a href="vocabulary.html">Word Bank</a>
        <a href="index.html">Main Page</a>
        <a href="parents.html">Wiki Parents</a>
    </nav>
</nav>

<section class="hero-compact">
    <h1>Lesson Time</h1>
    <div class="hero-date" id="hero-subtitle">Ready to learn?</div>
</section>

<div class="container">
    <div class="back-btn-wrapper">
        <a href="exercises.html" class="back-btn">
            <svg class="icon" viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            Back
        </a>
    </div>

    <div id="lesson-container">
        </div>
</div>

<div class="sticker-modal" id="modal" onclick="this.style.display='none'">
    <div class="sticker-content">
        <svg class="sticker-icon" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
        <h2 style="color: var(--navy); margin-bottom: 10px; font-size: 32px;">Excellent!</h2>
        <p style="color: #64748b; font-size: 18px;">Lesson Complete!</p>
        <button class="complete-btn" style="margin-top: 25px; width: 100%;" onclick="window.location.href='exercises.html'">
            Back to Menu
        </button>
    </div>
</div>

<script>
    // ===========================================
    // SVG ICONS (CONSTANTS)
    // ===========================================
    const ICONS = {
        play: '<svg class="play-icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>',
        mic: '<svg class="icon" viewBox="0 0 24 24"><path fill="white" d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path fill="white" d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>',
        check: '<svg class="icon" viewBox="0 0 24 24"><path fill="white" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>',
        speaker: '<svg class="icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>'
    };

    // ===========================================
    // DATABASE (Updated from PDF Content)
    // ===========================================
    const db = {
        "Sep": [
            {
                title: "My Family (Unit 1)", tag: "Unit 1: Family",
                goal: "Goal: Greetings & Family members. [cite: 216]",
                steps: [
                    { label: "Vocabulary", badge: "badge-vocab", title: "Family Members", en: "Tap to listen & repeat", zh: "點擊卡片聽發音", type: "flashcards", 
                      items: [
                          { w: "Family", zh: "家庭" }, 
                          { w: "Daddy", zh: "爸爸" },
                          { w: "Mommy", zh: "媽媽" }
                      ] 
                    },
                    { label: "Action (TPR)", badge: "badge-tpr", title: "Love your family", en: "Hug Daddy! Kiss Mommy!", zh: "擁抱爸爸！親吻媽媽！[cite: 224]", type: "simple", text: "Hug Daddy and Kiss Mommy!" },
                    { label: "Speaking", badge: "badge-speak", title: "Challenge", en: "Say: 'Good morning, Daddy.'", zh: "錄音挑戰 [cite: 216]", phrase: "Good morning, Daddy.", type: "speak" }
                ]
            },
            {
                title: "My School (Unit 2)", tag: "Unit 2: School",
                goal: "Goal: Identify classroom objects and greetings. [cite: 432]",
                steps: [
                    { label: "Vocabulary", badge: "badge-vocab", title: "Objects", en: "Tap to listen", zh: "點擊聽發音", type: "flashcards", 
                      items: [ { w: "Teacher", zh: "老師" }, { w: "Bag", zh: "書包" }, { w: "Book", zh: "書本" } ] 
                    },
                    { label: "Phonics", badge: "badge-phonics", title: "Letter Bb", en: "B is for Bag.", zh: "B 的發音 /b/ [cite: 610]", type: "flashcards", items: [{w: "Bb", zh: "/b/"}, {w: "Bag", zh: "書包"}] },
                    { label: "Speaking", badge: "badge-speak", title: "Challenge", en: "Say: 'Hello, I am Kelly.'", zh: "錄音挑戰 [cite: 433]", phrase: "Hello, I am Kelly.", type: "speak" }
                ]
            },
            {
                title: "Phonics & TPR", tag: "Unit 2: Practice",
                goal: "Goal: Classroom commands and Phonics. [cite: 445]",
                steps: [
                    { label: "Action (TPR)", badge: "badge-tpr", title: "Commands", en: "1. Open your book.<br>2. Show me your book.", zh: "1. 打開書。 2. 給我看書。", type: "simple", text: "Follow the commands!" },
                    { label: "Speaking", badge: "badge-speak", title: "Challenge", en: "Say: 'Open your book.'", zh: "錄音挑戰", phrase: "Open your book.", type: "speak" }
                ]
            },
            {
                title: "Review 1", tag: "Revision 1",
                goal: "Goal: Review Units 1 & 2.",
                steps: [
                    { label: "Vocabulary", badge: "badge-vocab", title: "Review", en: "Tap to check", zh: "複習", type: "flashcards", items: [ { w: "Daddy", zh: "Father" }, { w: "Teacher", zh: "Miss Wang" } ] },
                    { label: "Speaking", badge: "badge-speak", title: "Roleplay", en: "Say: 'Kiss Mommy.'", zh: "角色扮演 [cite: 675]", phrase: "Kiss Mommy.", type: "speak" }
                ]
            }
        ],
        "Oct": [
            {
                title: "Boy or Girl? (Unit 3)", tag: "Unit 3: Friends",
                goal: "Goal: Understand gender and friendship. [cite: 818]",
                steps: [
                    { label: "Vocabulary", badge: "badge-vocab", title: "Gender", en: "Tap to listen", zh: "點擊聽音", type: "flashcards", items: [{w:"Boy", zh:"男孩"}, {w:"Girl", zh:"女孩"}, {w:"Friend", zh:"朋友"}] },
                    { label: "Action (TPR)", badge: "badge-tpr", title: "Commands", en: "Stand up! Sit down!", zh: "起立！坐下！[cite: 826]", type: "simple", text: "Stand up and Sit down." },
                   { label: "Speaking", badge: "badge-speak", title: "Record", en: "Say: 'You are a boy.'", zh: "錄音 [cite: 818]", phrase: "You are a boy.", type: "speak" }
                ]
            },
            {
                title: "Phonics Gg (Unit 3)", tag: "Unit 3: Phonics",
                goal: "Goal: Learn Letter G /g/. [cite: 971]",
                steps: [
                    { label: "Phonics", badge: "badge-phonics", title: "Letter G", en: "G is for...", zh: "G發音", type: "flashcards", items: [{w:"Gg", zh:"/g/"}, {w:"Girl", zh:"女孩"}, {w:"Game", zh:"遊戲"}] },
                    { label: "Speaking", badge: "badge-speak", title: "Record", en: "Say: 'Stand up, please.'", zh: "錄音", phrase: "Stand up, please.", type: "speak" }
                ]
            }
        ],
        "Nov": [
            {
                title: "My Face (Unit 4)", tag: "Unit 4: Face",
                goal: "Goal: Learn face parts. [cite: 1018]",
                steps: [
                    { label: "Vocabulary", badge: "badge-vocab", title: "Parts", en: "Tap to listen", zh: "五官", type: "flashcards", items: [{w:"Eye", zh:"眼睛"}, {w:"Nose", zh:"鼻子"}, {w:"Mouth", zh:"嘴巴"}, {w:"Ear", zh:"耳朵"}] },
                    { label: "Action (TPR)", badge: "badge-tpr", title: "Touch!", en: "Close your eyes. Open your eyes.", zh: "閉眼 / 睜眼 [cite: 1025]", type: "simple", text: "Close and Open your eyes." },
                    { label: "Speaking", badge: "badge-speak", title: "Record", en: "Say: 'This is my nose.'", zh: "錄音 [cite: 1017]", phrase: "This is my nose.", type: "speak" }
                ]
            },
            {
                title: "Phonics Mm (Unit 4)", tag: "Unit 4: Phonics",
                goal: "Goal: Letter M /m/. [cite: 1176]",
                steps: [
                    { label: "Phonics", badge: "badge-phonics", title: "Letter M", en: "M is for...", zh: "M發音", type: "flashcards", items: [{w:"Mm", zh:"/m/"}, {w:"Monkey", zh:"猴子"}, {w:"Mouth", zh:"嘴巴"}] },
                    { label: "Speaking", badge: "badge-speak", title: "Record", en: "Say: 'My mouth.'", zh: "錄音", phrase: "My mouth.", type: "speak" }
                ]
            }
        ],
        "Dec": [
            {
                title: "On the Farm (Unit 5)", tag: "Unit 5: Farm",
                goal: "Goal: Farm animals and numbers 1-3. [cite: 1369]",
                steps: [
                    { label: "Vocabulary", badge: "badge-vocab", title: "Animals", en: "Tap to listen", zh: "農場動物", type: "flashcards", items: [{w:"Cow", zh:"牛"}, {w:"Pig", zh:"豬"}, {w:"Hen", zh:"母雞"}, {w:"Duck", zh:"鴨"}] },
                    { label: "Vocabulary", badge: "badge-vocab", title: "Numbers", en: "1, 2, 3", zh: "數字", type: "flashcards", items: [{w:"One", zh:"1"}, {w:"Two", zh:"2"}, {w:"Three", zh:"3"}] },
                    { label: "Speaking", badge: "badge-speak", title: "Record", en: "Say: 'Look! Two pigs.'", zh: "錄音 [cite: 1368]", phrase: "Look! Two pigs.", type: "speak" }
                ]
            },
            {
                title: "Phonics Pp (Unit 5)", tag: "Unit 5: Phonics",
                goal: "Goal: Letter P /p/ and TPR. [cite: 1543]",
                steps: [
                    { label: "Phonics", badge: "badge-phonics", title: "Letter P", en: "P is for...", zh: "P發音", type: "flashcards", items: [{w:"Pp", zh:"/p/"}, {w:"Pig", zh:"豬"}, {w:"Pink", zh:"粉色"}] },
                    { label: "Action (TPR)", badge: "badge-tpr", title: "Count", en: "Show me your fingers. Count the ducks.", zh: "給我看手指。數數鴨子。[cite: 1377]", type: "simple", text: "Show fingers and count!" },
                    { label: "Speaking", badge: "badge-speak", title: "Record", en: "Say: 'A pink pig.'", zh: "錄音", phrase: "A pink pig.", type: "speak" }
                ]
            }
        ],
        "Jan": [
            {
                title: "At the Zoo (Unit 6)", tag: "Unit 6: Zoo",
                goal: "Goal: Wild animals and numbers 4-5. [cite: 1593]",
                steps: [
                    { label: "Vocabulary", badge: "badge-vocab", title: "Wild Animals", en: "Tap to listen", zh: "野生動物", type: "flashcards", items: [{w:"Panda", zh:"熊貓"}, {w:"Tiger", zh:"老虎"}, {w:"Bear", zh:"熊"}, {w:"Monkey", zh:"猴子"}] },
                    { label: "Action (TPR)", badge: "badge-tpr", title: "Photo", en: "Look at the panda. Take a photo.", zh: "看熊貓。拍照。[cite: 1600]", type: "simple", text: "Click! Take a photo." },
                    { label: "Speaking", badge: "badge-speak", title: "Record", en: "Say: 'Four pandas.'", zh: "錄音 [cite: 1588]", phrase: "Four pandas.", type: "speak" }
                ]
            },
            {
                title: "Phonics Tt (Unit 6)", tag: "Unit 6: Phonics",
                goal: "Goal: Letter T /t/. [cite: 1760]",
                steps: [
                    { label: "Phonics", badge: "badge-phonics", title: "Letter T", en: "T is for...", zh: "T發音", type: "flashcards", items: [{w:"Tt", zh:"/t/"}, {w:"Tiger", zh:"老虎"}, {w:"Tea", zh:"茶"}] },
                    { label: "Speaking", badge: "badge-speak", title: "Record", en: "Say: 'Take a photo.'", zh: "錄音", phrase: "Take a photo.", type: "speak" }
                ]
            }
        ],
        "Feb": [
            {
                title: "On the Road (Unit 7)", tag: "Unit 7: Transport",
                goal: "Goal: Vehicles and traffic rules. [cite: 4]",
                steps: [
                    { label: "Vocabulary", badge: "badge-vocab", title: "Vehicles", en: "Tap to listen", zh: "交通工具", type: "flashcards", items: [{w:"Car", zh:"車"}, {w:"Bus", zh:"巴士"}, {w:"Bike", zh:"自行車"}, {w:"Taxi", zh:"的士"}] },
                    { label: "Action (TPR)", badge: "badge-tpr", title: "Traffic", en: "Stop. Wait. Go.", zh: "停。等。走。[cite: 11]", type: "simple", text: "Red light: Stop. Green light: Go." },
                    { label: "Speaking", badge: "badge-speak", title: "Record", en: "Say: 'Oh, my bike!'", zh: "錄音 [cite: 3]", phrase: "Oh, my bike!", type: "speak" }
                ]
            },
            {
                title: "Phonics Cc (Unit 7)", tag: "Unit 7: Phonics",
                goal: "Goal: Letter C /k/. [cite: 169]",
                steps: [
                    { label: "Phonics", badge: "badge-phonics", title: "Letter C", en: "C is for...", zh: "C發音", type: "flashcards", items: [{w:"Cc", zh:"/k/"}, {w:"Cat", zh:"貓"}, {w:"Car", zh:"車"}] },
                    { label: "Speaking", badge: "badge-speak", title: "Record", en: "Say: 'Stop and Go.'", zh: "錄音", phrase: "Stop and Go.", type: "speak" }
                ]
            }
        ]
    };

    // LOGIC
    function loadLesson() {
        const params = new URLSearchParams(window.location.search);
        const month = params.get('m');
        const weekIndex = parseInt(params.get('w'));

        if (!month || !db[month] || !db[month][weekIndex]) {
            document.getElementById('lesson-container').innerHTML = `
                <div style="text-align:center; padding: 40px; background:white; border-radius:24px;">
                    <h2 style="color:var(--navy)">Content Coming Soon</h2>
                    <p>This lesson is under development.</p>
                    <a href="exercises.html" class="back-btn" style="margin-top:20px;">Back</a>
                </div>
            `;
            return;
        }

        const lesson = db[month][weekIndex];

        // 1. HEADER
        let html = `
            <div class="lesson-header-card">
                <span class="lesson-tag">${lesson.tag}</span>
                <h1 class="lesson-title">${lesson.title}</h1>
                <div class="lesson-subtitle">${month} • Week ${weekIndex + 1}</div>
                <div class="lesson-goal">${lesson.goal}</div>
            </div>
        `;

        // 2. STEPS
        let stepCount = 0;
        lesson.steps.forEach((step, index) => {
            stepCount++;
            html += `
                <div class="step-card">
                    <span class="step-badge ${step.badge}">${step.label}</span>
                    <div class="step-title">${step.title}</div>
                    <div class="step-desc-en">${step.en}</div>
                    <div class="step-desc-zh">${step.zh}</div>
            `;

            // FLASHCARDS
            if (step.type === 'flashcards' && step.items) {
                html += `<div class="flashcards-grid">`;
                step.items.forEach(item => {
                    html += `
                        <div class="flashcard" onclick="speakText('${item.w}')">
                            <div class="flashcard-word">${item.w}</div>
                            <div class="flashcard-zh">${item.zh}</div>
                            ${ICONS.speaker}
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // SIMPLE TEXT/ACTION
            if (step.type === 'simple' && step.text) {
                html += `
                    <div style="margin-top:15px; padding:15px; background:#f1f5f9; border-radius:12px; font-style:italic; color:#475569;">
                        ${step.text}
                    </div>
                `;
            }

            // SPEAKING
            if (step.type === 'speak') {
                html += `
                    <div class="audio-box">
                        <button class="rec-btn" onclick="toggleRecord(this)">${ICONS.mic}</button>
                        <div style="flex:1">
                            <strong style="color:var(--navy); display:block; margin-bottom:5px;">Tap mic & say:</strong>
                            <span style="font-size:18px; font-weight:700;">"${step.phrase}"</span><br>
                            <button class="listen-btn" onclick="speakText('${step.phrase}')">${ICONS.speaker} Listen first</button>
                        </div>
                    </div>
                `;
            }

            html += `</div>`;
        });

        // 3. FOOTER
        html += `
            <button class="complete-btn" onclick="finishLesson()">
                ${ICONS.check} Complete Mission
            </button>
        `;

        document.getElementById('lesson-container').innerHTML = html;
        
        // Progress Bar (Simple animation)
        setTimeout(() => { document.getElementById('progress-bar').style.width = '20%'; }, 500);
    }

    // --- UTILS ---
    function speakText(text) {
        if ('speechSynthesis' in window) {
            const msg = new SpeechSynthesisUtterance();
            msg.text = text;
            msg.lang = 'en-US';
            msg.rate = 0.8; 
            window.speechSynthesis.speak(msg);
        } else {
            alert("Audio not supported in this browser");
        }
    }

    let isRecording = false;
    function toggleRecord(btn) {
        // Simple UI simulation of recording
        if (!isRecording) {
            btn.classList.add('recording');
            isRecording = true;
            // Update progress bar
            let currentWidth = parseInt(document.getElementById('progress-bar').style.width) || 20;
            document.getElementById('progress-bar').style.width = Math.min(currentWidth + 25, 90) + '%';
        } else {
            btn.classList.remove('recording');
            isRecording = false;
            // Success Audio Feedback
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.setValueAtTime(600, ctx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1000, ctx.currentTime + 0.1);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
            osc.start();
            osc.stop(ctx.currentTime + 0.5);
        }
    }

    function finishLesson() {
        document.getElementById('progress-bar').style.width = '100%';
        document.getElementById('modal').style.display = 'flex';
        
        if (typeof confetti === 'function') {
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: ['#22d3ee', '#f97316', '#a78bfa']
            });
        }
    }

    loadLesson();
</script>

</body>
</html>
