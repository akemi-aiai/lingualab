<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson ‚Äî LinguaLab</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root { 
            --primary: #22d3ee; 
            --primary-light: #ecfeff;
            --navy: #1f4e79; 
            --bg: #f8fafc; 
            --white: #ffffff; 
            --orange: #f97316; 
            --green: #10b981;
            --radius: 24px;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: #334155; padding-top: 80px; padding-bottom: 80px; }
        
        /* --- ICONS --- */
        .icon { width: 24px; height: 24px; fill: currentColor; vertical-align: text-bottom; }

        /* --- NAVBAR (Identical to Grammar/Exercises) --- */
        .navbar {
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px 40px; background: #fff; box-shadow: 0 4px 20px rgba(0,0,0,.05);
            height: 80px;
        }
        .navbar-left { display: flex; align-items: center; gap: 12px; }
        .nav-logo { height: 40px; width: auto; display: block; }
        .nav-title { font-size: 24px; font-weight: 800; color: var(--navy); }
        .navbar-right { display: flex; align-items: center; gap: 20px; }
        .navbar-right a { 
            color: var(--navy); font-weight: 600; text-decoration: none; 
            font-size: 14px; transition: 0.3s;
        }
        .navbar-right a:hover { color: var(--primary); }

        /* PARENT TOGGLE (In Navbar) */
        .parent-switch {
            display: flex; align-items: center; gap: 8px; 
            background: #f1f5f9; padding: 6px 12px; border-radius: 99px; cursor: pointer; border: 1px solid #e2e8f0;
        }
        .parent-switch.active { background: var(--navy); color: white; border-color: var(--navy); }
        .switch-label { font-size: 12px; font-weight: 700; text-transform: uppercase; }

        /* --- PROGRESS BAR --- */
        .progress-container {
            position: fixed; top: 80px; left: 0; width: 100%; height: 6px; background: #e2e8f0; z-index: 999;
        }
        .progress-fill {
            height: 100%; background: var(--orange); width: 0%; transition: width 0.5s ease;
        }

        /* --- HERO (Identical dimensions) --- */
        .hero-compact {
            width: 100%;
            padding: 60px 20px 160px; /* Big padding for overlap */
            text-align: center;
            background: linear-gradient(135deg, #22d3ee, #a78bfa);
            color: #fff;
            position: relative;
        }
        .hero-compact h1 { font-size: 42px; font-weight: 800; margin-bottom: 10px; }
        .hero-info { font-size: 18px; opacity: 0.95; }

        /* --- CONTAINER --- */
        .container { 
            max-width: 700px; margin: -100px auto 0; 
            padding: 0 20px; position: relative; z-index: 10;
        }

        /* --- CARDS & SCREENS --- */
        .screen { display: none; animation: fadeUp 0.4s ease; }
        .screen.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card {
            background: white; border-radius: var(--radius); padding: 40px;
            box-shadow: var(--shadow); margin-bottom: 30px; text-align: center;
            border: 1px solid #e2e8f0;
        }

        /* --- START SCREEN --- */
        .trust-badges { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .badge { background: #f0f9ff; color: var(--navy); padding: 5px 12px; border-radius: 6px; font-size: 12px; font-weight: 700; }
        
        .promise-box { margin: 25px 0; text-align: left; background: #f8fafc; padding: 20px; border-radius: 16px; }
        .promise-item { display: flex; gap: 10px; margin-bottom: 12px; font-size: 15px; color: #475569; align-items: center; }
        .check-icon { color: var(--green); font-weight: bold; }

        /* --- LESSON STEPS --- */
        .step-header { margin-bottom: 20px; }
        .step-tag { 
            color: var(--primary); font-weight: 800; text-transform: uppercase; 
            font-size: 12px; letter-spacing: 1px; display: block; margin-bottom: 5px;
        }
        .step-title { font-size: 28px; font-weight: 800; color: var(--navy); }
        
        /* Parent Tip Box (Hidden by default) */
        .parent-tip {
            display: none; text-align: left; background: #fff7ed; 
            border-left: 4px solid var(--orange); padding: 15px; 
            border-radius: 8px; margin-bottom: 25px; font-size: 14px; color: #9a3412;
        }
        
        /* Flashcards Grid */
        .flashcards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px; margin: 20px 0; }
        .flashcard {
            background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 16px;
            padding: 15px; cursor: pointer; transition: 0.2s;
        }
        .flashcard:hover { border-color: var(--primary); background: #ecfeff; transform: scale(1.05); }
        .fc-icon { font-size: 32px; display: block; margin-bottom: 5px; }
        .fc-word { font-weight: 700; color: var(--navy); font-size: 14px; }

        /* Audio Controls */
        .audio-control {
            background: #f1f5f9; padding: 20px; border-radius: 16px; 
            display: flex; align-items: center; gap: 15px; margin: 20px 0;
        }
        .play-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none; background: var(--primary); 
            color: white; cursor: pointer; display: flex; justify-content: center; align-items: center;
        }
        .mic-btn {
            width: 60px; height: 60px; border-radius: 50%; border: none; background: #ef4444; 
            color: white; cursor: pointer; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3); transition: 0.2s;
        }
        .mic-btn:hover { transform: scale(1.1); }
        .mic-btn.recording { animation: pulse 1.5s infinite; background: #b91c1c; }

        /* Offscreen Mission */
        .mission-box {
            border: 2px dashed #cbd5e1; padding: 20px; border-radius: 16px; margin: 20px 0;
            background: #f8fafc; color: #475569;
        }

        /* Footer Nav */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: white; padding: 15px 20px; 
            border-top: 1px solid #e2e8f0; display: flex; gap: 10px; z-index: 1000;
            justify-content: center;
        }
        .nav-btn {
            background: var(--navy); color: white; border: none; 
            padding: 16px 32px; border-radius: 14px; font-size: 16px; 
            font-weight: 700; cursor: pointer; width: 100%; max-width: 600px;
            transition: 0.2s;
        }
        .nav-btn:hover { background: #334155; }
        .nav-btn.secondary { background: white; color: var(--navy); border: 2px solid #e2e8f0; }

        /* REPORT CARD */
        .report-list { text-align: left; margin: 20px 0; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; }
        .report-item { margin-bottom: 10px; font-size: 15px; color: #334155; display: flex; align-items: center; gap: 10px; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.6); } 70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); } }

        @media (max-width: 600px) {
            .navbar { padding: 10px 20px; height: auto; flex-direction: column; gap: 10px; }
            .navbar-right { width: 100%; justify-content: center; flex-wrap: wrap; border-top: 1px solid #f1f5f9; padding-top: 10px; }
            .hero-compact h1 { font-size: 32px; }
            .container { margin-top: -80px; }
            .progress-container { top: 110px; }
        }
    </style>
</head>
<body>

<div class="progress-container"><div class="progress-fill" id="progress-bar"></div></div>

<nav class="navbar">
    <div class="navbar-left">
        <img src="assets/img/logo.png" alt="LL" class="nav-logo" onerror="this.style.display='none'">
        <span class="nav-title">LinguaLab</span>
    </div>
    <div class="navbar-right">
        <div class="parent-switch" onclick="toggleParentMode()">
            <span class="switch-label">Parent Mode</span>
            <svg class="icon" style="width:20px; height:20px;" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
        </div>
        <a href="exercises.html" style="margin-left:15px; font-weight:700;">Exit Lesson</a>
    </div>
</nav>

<section class="hero-compact">
    <h1>Fun Homework</h1>
    <div class="hero-info" id="hero-date">Ready to play?</div>
</section>

<div class="container">

    <div id="screen-start" class="screen active">
        <div class="card">
            <div class="trust-badges">
                <span class="badge">Ages 3‚Äì6</span>
                <span class="badge">7 Minutes</span>
                <span class="badge">Zero Prep</span>
            </div>
            <h2 style="font-size:32px; color:var(--navy); margin-bottom:10px;">7 Minutes.<br>Just press Play.</h2>
            <p style="color:#64748b; margin-bottom:20px;">No teacher needed. We guide you step-by-step.</p>
            
            <div class="promise-box">
                <div class="promise-item"><span class="check-icon">‚úì</span> <b>Today:</b> 6 words + 1 phrase + 1 game</div>
                <div class="promise-item"><span class="check-icon">‚úì</span> <b>Anxiety Relief:</b> Child tired? Use "2-min mode"</div>
                <div class="promise-item"><span class="check-icon">‚úì</span> <b>Result:</b> Visible progress today</div>
            </div>

            <button class="nav-btn" onclick="startLesson()">Start Lesson ‚ñ∂</button>
        </div>
    </div>

    <div id="screen-lesson" class="screen">
        <div class="card" id="lesson-card-content">
            </div>
        
        <div class="bottom-nav">
            <button class="nav-btn secondary" style="width:30%" onclick="prevStep()">Back</button>
            <button class="nav-btn" style="width:70%" onclick="nextStep()" id="next-btn">Next Step ‚Üí</button>
        </div>
    </div>

    <div id="screen-report" class="screen">
        <div class="card" style="border-top: 6px solid var(--green);">
            <div style="font-size:60px; margin-bottom:10px;">üèÜ</div>
            <h2 style="color:var(--navy); margin-bottom:5px;">You did it!</h2>
            <p style="color:#64748b;">You are a Tiny Hero.</p>

            <div class="report-list">
                <div style="font-weight:800; color:var(--navy); margin-bottom:15px; text-transform:uppercase; font-size:12px;">Parent Report</div>
                <div class="report-item">
                    <svg class="icon" style="color:var(--green)" viewBox="0 0 24 24"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                    <span><b>Learned:</b> <span id="report-vocab"></span></span>
                </div>
                <div class="report-item">
                    <svg class="icon" style="color:var(--green)" viewBox="0 0 24 24"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                    <span><b>Spoke:</b> <span id="report-phrase"></span></span>
                </div>
                <div class="report-item">
                    <svg class="icon" style="color:var(--green)" viewBox="0 0 24 24"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                    <span><b>Next Time:</b> Review & Play</span>
                </div>
            </div>

            <button class="nav-btn" onclick="window.location.href='exercises.html'">Back to Dashboard</button>
        </div>
    </div>

</div>

<script>
    // --- ICONS ---
    const ICON_AUDIO = '<svg class="icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>';
    const ICON_PLAY = '<svg class="icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
    const ICON_MIC = '<svg class="icon" style="width:30px;height:30px" viewBox="0 0 24 24"><path fill="white" d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path fill="white" d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>';

    // --- CONTENT DB (Sep-Feb) ---
    const db = {
        "Sep": [
            {
                unit: "Unit 1: Family", vocab: "Daddy, Mommy", phrase: "Good morning Daddy",
                steps: [
                    { type: 'warmup', tag: 'A. Warm Up', title: "Listen & Wave", text: "Let's say Hello!", action: "Wave your hand üëã", phrase: "Hello!" },
                    { type: 'words', tag: 'B. 3 Words', title: "Family Members", items: [{w:"Daddy", i:"üë®"},{w:"Mommy", i:"üë©"},{w:"Family", i:"üè†"}] },
                    { type: 'phrase', tag: 'C. Phrase', title: "Phrase of the Day", text: "Good morning, Daddy.", script: "Ask: Who do you see in the morning?", parentTip: "Don't correct pronunciation yet. Just praise effort." },
                    { type: 'game', tag: 'D. Game', title: "Hug Game", text: "Run and hug Mommy/Daddy!", sub: "Ready? Go!" },
                    { type: 'offscreen', tag: 'E. Mission', title: "Real World", text: "Find a family photo.", icon: "üñºÔ∏è" }
                ]
            },
            {
                unit: "Unit 2: School", vocab: "Bag, Book", phrase: "It is a book",
                steps: [
                    { type: 'warmup', tag: 'A. Warm Up', title: "Stand Up!", text: "Stand up... Sit down.", action: "Do it 3 times.", phrase: "Stand up!" },
                    { type: 'words', tag: 'B. 3 Words', title: "School Objects", items: [{w:"Bag", i:"üéí"},{w:"Book", i:"üìñ"},{w:"Pencil", i:"‚úèÔ∏è"}] },
                    { type: 'phrase', tag: 'C. Phrase', title: "Phrase of the Day", text: "It is a book.", script: "Point to a book and ask: What is this?", parentTip: "Say the word first, let them repeat." },
                    { type: 'game', tag: 'D. Game', title: "Hide & Seek", text: "Hide a book. Ask: Where is the book?", sub: "Child finds it." },
                    { type: 'offscreen', tag: 'E. Mission', title: "Real World", text: "Put a book in a bag.", icon: "üéí" }
                ]
            },
            {
                unit: "Unit 2: Phonics", vocab: "Bb /b/", phrase: "Open book",
                steps: [
                    { type: 'warmup', tag: 'A. Warm Up', title: "Clap Hands", text: "Clap 1, 2, 3.", action: "Clap!", phrase: "Clap!" },
                    { type: 'words', tag: 'B. Words', title: "B Sound", items: [{w:"Bb", i:"üÖ±Ô∏è"},{w:"Ball", i:"‚öΩ"},{w:"Baby", i:"üë∂"}] },
                    { type: 'phrase', tag: 'C. Action', title: "TPR Command", text: "Open your book.", script: "Model the action first.", parentTip: "Emphasize the 'b' sound in Book." },
                    { type: 'game', tag: 'D. Game', title: "Blue Hunt", text: "Find something BLUE.", sub: "B is for Blue." },
                    { type: 'offscreen', tag: 'E. Mission', title: "Real World", text: "Find a blue toy.", icon: "üîµ" }
                ]
            },
            {
                unit: "Revision 1", vocab: "Mike, Kelly", phrase: "Hello I am...",
                steps: [
                    { type: 'warmup', tag: 'A. Warm Up', title: "Shake", text: "Shake your body!", action: "Shake!", phrase: "Shake!" },
                    { type: 'words', tag: 'B. Words', title: "Review", items: [{w:"Mike", i:"üë¶"},{w:"Kelly", i:"üëß"},{w:"Teacher", i:"üë©‚Äçüè´"}] },
                    { type: 'phrase', tag: 'C. Phrase', title: "Roleplay", text: "Hello, I am [Name].", script: "Practice with a puppet.", parentTip: "Roleplay builds confidence." },
                    { type: 'game', tag: 'D. Game', title: "Who is it?", text: "Guess the character.", sub: "Mike or Kelly?" },
                    { type: 'offscreen', tag: 'E. Mission', title: "Real World", text: "Say Hello to a toy.", icon: "üß∏" }
                ]
            }
        ],
        "Oct": [
            {
                unit: "Unit 3: Friends", vocab: "Boy, Girl", phrase: "I am a girl",
                steps: [
                    { type: 'warmup', tag: 'A. Warm Up', title: "High Five", text: "High five!", action: "High five!", phrase: "High five!" },
                    { type: 'words', tag: 'B. Words', title: "Gender", items: [{w:"Boy", i:"üë¶"},{w:"Girl", i:"üëß"},{w:"Friend", i:"ü§ù"}] },
                    { type: 'phrase', tag: 'C. Phrase', title: "Phrase", text: "I am a girl/boy.", script: "Ask: Are you a boy?", parentTip: "Use family photos to show he/she." },
                    { type: 'game', tag: 'D. Game', title: "Stand Up", text: "Boys stand up! Girls sit down!", sub: "Listen carefully." },
                    { type: 'offscreen', tag: 'E. Mission', title: "Real World", text: "Count boys in your family.", icon: "üë®‚Äçüë©‚Äçüë¶" }
                ]
            },
            {
                unit: "Unit 3: Phonics", vocab: "Gg /g/", phrase: "Stand up",
                steps: [
                    { type: 'warmup', tag: 'A. Warm Up', title: "Wiggle", text: "Wiggle fingers.", action: "Wiggle!", phrase: "Wiggle" },
                    { type: 'words', tag: 'B. Words', title: "G Sound", items: [{w:"Gg", i:"üî§"},{w:"Girl", i:"üëß"},{w:"Game", i:"üé≤"}] },
                    { type: 'phrase', tag: 'C. Phrase', title: "Command", text: "Stand up, please.", script: "Be polite.", parentTip: "G sounds like 'guh'." },
                    { type: 'game', tag: 'D. Game', title: "Simon Says", text: "Simon says: Sit down.", sub: "Don't get tricked." },
                    { type: 'offscreen', tag: 'E. Mission', title: "Real World", text: "Play a quick game.", icon: "üèÉ" }
                ]
            }
        ],
        "Nov": [
            {
                unit: "Unit 4: Face", vocab: "Eyes, Nose", phrase: "My nose",
                steps: [
                    { type: 'warmup', tag: 'A. Warm Up', title: "Blink", text: "Blink your eyes.", action: "Blink!", phrase: "Blink" },
                    { type: 'words', tag: 'B. Words', title: "Face Parts", items: [{w:"Eye", i:"üëÅÔ∏è"},{w:"Nose", i:"üëÉ"},{w:"Mouth", i:"üëÑ"}] },
                    { type: 'phrase', tag: 'C. Phrase', title: "Phrase", text: "This is my nose.", script: "Touch your nose.", parentTip: "Touch your own face to demonstrate." },
                    { type: 'game', tag: 'D. Game', title: "Touch", text: "Touch your... Mouth!", sub: "Fast!" },
                    { type: 'offscreen', tag: 'E. Mission', title: "Real World", text: "Look in a mirror.", icon: "ü™û" }
                ]
            }
        ],
        // Additional months would follow the same pattern...
        "Dec": [{unit:"Unit 5", vocab:"Cow, Pig", phrase:"It is a cow", steps:[{type:'words', items:[{w:'Cow',i:'üêÆ'},{w:'Pig',i:'üê∑'},{w:'Duck',i:'ü¶Ü'}]}]}],
        "Jan": [{unit:"Unit 6", vocab:"Panda", phrase:"Look at panda", steps:[{type:'words', items:[{w:'Panda',i:'üêº'},{w:'Tiger',i:'üêØ'},{w:'Bear',i:'üêª'}]}]}],
        "Feb": [{unit:"Unit 7", vocab:"Car, Bus", phrase:"It is a bus", steps:[{type:'words', items:[{w:'Car',i:'üöó'},{w:'Bus',i:'üöå'},{w:'Bike',i:'üö≤'}]}]}]
    };

    // --- LOGIC ---
    let currentData = null;
    let stepIndex = 0;
    let isRecording = false;

    function init() {
        const params = new URLSearchParams(window.location.search);
        const m = params.get('m');
        const w = parseInt(params.get('w')) || 0;

        if (m && db[m] && db[m][w]) {
            currentData = db[m][w];
            document.getElementById('hero-date').innerText = currentData.unit;
        } else {
            // Fallback content if empty
            currentData = db["Sep"][0]; 
        }
    }

    function toggleParentMode() {
        const btn = document.querySelector('.parent-switch');
        btn.classList.toggle('active');
        document.querySelectorAll('.parent-tip').forEach(el => {
            el.style.display = btn.classList.contains('active') ? 'block' : 'none';
        });
    }

    function startLesson() {
        document.getElementById('screen-start').classList.remove('active');
        document.getElementById('screen-lesson').classList.add('active');
        renderStep(0);
    }

    function renderStep(idx) {
        stepIndex = idx;
        const step = currentData.steps[idx];
        const card = document.getElementById('lesson-card-content');
        
        // Progress Bar
        const pct = ((idx + 1) / currentData.steps.length) * 100;
        document.getElementById('progress-bar').style.width = pct + '%';

        // Next Button Logic
        const nextBtn = document.getElementById('next-btn');
        if (idx === currentData.steps.length - 1) {
            nextBtn.innerText = "Finish üéâ";
            nextBtn.onclick = finishLesson;
        } else {
            nextBtn.innerText = "Next Step ‚Üí";
            nextBtn.onclick = nextStep;
        }

        // Render Content based on Type
        let html = `
            <div class="step-header">
                <span class="step-tag">${step.tag}</span>
                <h2 class="step-title">${step.title}</h2>
            </div>
        `;

        // Parent Tip
        if (step.parentTip) {
            html += `<div class="parent-tip">üí° <b>Parent Tip:</b> ${step.parentTip}</div>`;
        }

        // A. WARMUP
        if (step.type === 'warmup') {
            html += `
                <div class="audio-control" style="justify-content:center; flex-direction:column; text-align:center;">
                    <button class="play-btn" onclick="speak('${step.phrase}')">${ICON_PLAY}</button>
                    <p style="font-size:18px; font-weight:600; margin:10px 0;">${step.text}</p>
                    <p style="color:#64748b;">${step.action}</p>
                </div>
            `;
        }

        // B. WORDS
        else if (step.type === 'words') {
            html += `<div class="flashcards-grid">`;
            step.items.forEach(item => {
                html += `
                    <div class="flashcard" onclick="speak('${item.w}')">
                        <div class="fc-icon">${item.i}</div>
                        <div class="fc-word">${item.w}</div>
                        ${ICON_AUDIO}
                    </div>`;
            });
            html += `</div>`;
        }

        // C. PHRASE / SPEAKING
        else if (step.type === 'phrase' || step.type === 'speak') {
            html += `
                <div style="background:#ecfeff; padding:20px; border-radius:12px; margin-bottom:20px; text-align:left;">
                    <div style="font-size:12px; font-weight:700; color:var(--navy); text-transform:uppercase;">Script</div>
                    <div style="font-size:16px; color:#334155;">"${step.script || step.phrase}"</div>
                </div>
                <div class="audio-control">
                    <button class="mic-btn" onclick="toggleMic(this)">${ICON_MIC}</button>
                    <div style="flex:1; text-align:left;">
                        <strong style="color:var(--navy);">Your turn:</strong><br>
                        <span style="font-size:18px; font-weight:700;">"${step.text || step.phrase}"</span>
                        <div style="margin-top:5px; font-size:12px; color:#64748b; cursor:pointer;" onclick="speak('${step.text || step.phrase}')">üîä Listen first</div>
                    </div>
                </div>
            `;
        }

        // D. GAME
        else if (step.type === 'game') {
            html += `
                <div style="padding:40px; background:#fff7ed; border-radius:20px; border:2px dashed #fed7aa;">
                    <div style="font-size:50px; margin-bottom:10px;">üé≤</div>
                    <h3 style="color:#9a3412; margin-bottom:10px;">${step.text}</h3>
                    <p style="color:#64748b;">${step.sub}</p>
                </div>
            `;
        }

        // E. MISSION
        else if (step.type === 'offscreen') {
            html += `
                <div class="mission-box" style="text-align:center;">
                    <div style="font-size:60px; margin-bottom:10px;">${step.icon}</div>
                    <h3 style="color:#334155; margin-bottom:10px;">Off-Screen Mission</h3>
                    <p style="font-size:18px; font-weight:600; color:var(--navy);">${step.text}</p>
                    <p style="color:#64748b; font-size:13px; margin-top:10px;">Put the phone down and go!</p>
                </div>
            `;
        }

        card.innerHTML = html;
        
        // Re-apply parent mode visibility
        toggleParentMode();
        toggleParentMode(); // toggle twice to refresh state
    }

    function nextStep() {
        if (stepIndex < currentData.steps.length - 1) {
            renderStep(stepIndex + 1);
        }
    }

    function prevStep() {
        if (stepIndex > 0) {
            renderStep(stepIndex - 1);
        } else {
            document.getElementById('screen-lesson').classList.remove('active');
            document.getElementById('screen-start').classList.add('active');
        }
    }

    function toggleMic(btn) {
        if (!isRecording) {
            btn.classList.add('recording');
            isRecording = true;
        } else {
            btn.classList.remove('recording');
            isRecording = false;
            // Success sound
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.frequency.setValueAtTime(600, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
            osc.start();
            osc.stop(ctx.currentTime + 0.5);
        }
    }

    function speak(text) {
        if ('speechSynthesis' in window) {
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = 'en-US';
            msg.rate = 0.9;
            window.speechSynthesis.speak(msg);
        }
    }

    function finishLesson() {
        document.getElementById('screen-lesson').classList.remove('active');
        document.getElementById('screen-report').classList.add('active');
        
        // Populate Report
        document.getElementById('report-vocab').innerText = currentData.vocab;
        document.getElementById('report-phrase').innerText = `"${currentData.phrase}"`;

        if (typeof confetti === 'function') {
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#22d3ee', '#f97316', '#a78bfa'] });
        }
    }

    init();
</script>

</body>
</html>
